#!/usr/bin/env bash

VERSION=0.9

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

usage () {
	cat <<-EOT
		Usage: $0 [OPTION]... [PATTERN]
		Try '$0 -h|--help' for more information
		  -h, --help           display this help text and exit
		  -V, --version        display version information and exit
		  -d, --database-file  path to database file
		  -t, --search-type    type of search to execute:
		      		       	    fulltext|cpe|debian|rpm|
					    alpine|archlinux|npm|maven|pip|golang
		  -v, --pkg-version    cpe version when searching by cpe
		  -n, --pkg-name       path to database file
		  -w, --pkg-vendor     path to database file
	EOT
}

OPTIONS=$(
	getopt					\
		--options hVd:t:v:n:w:		\
		--longoptions help		\
		--longoptions version		\
		--longoptions database-file:	\
		--longoptions search-type:	\
		--longoptions pkg-version	\
		--longoptions pkg-name:		\
		--longoptions pkg-vendor:	\
		-- "$@"
)

if [[ ! $? -eq 0 ]]; then
	usage
	exit 1
fi

eval set -- "$OPTIONS"
unset OPTIONS

# Default values
searchtype=fulltext
databasefile=patton.db.zst

while true; do
	case "$1" in
		-h|--help)
			usage
			exit 0
			;;
		-V|--version)
			echo "$0: version $VERSION"
			exit 0
			;;
		-d|--database-file)
			shift
			databasefile="$1"
			;;
		-t|--search-type)
			shift
			searchtype="$1"
			;;
		-v|--pkg-version)
			shift
			pkgversion="$1"
			;;
		-n|--pkg-name)
			shift
			pkgname="$1"
			;;
		-w|--pkg-vendor)
			shift
			pkgvendor="$1"
			;;
		--)
			shift
			break
			;;
	esac
	shift
done

pattern="$@"

cat <<-EOT
	database-file = $databasefile
	search-type = $searchtype
	pkg-version = $pkgversion
	pkg-name = $pkgname
	pkg-vendor = $pkgvendor
	pattern = $pattern
EOT

case "$searchtype" in
	debian)
		:
		;;
	product)
		echo "searching product $pattern $pkgversion ..."
		zstdgrep -i -E "$pattern.*$pkgversion" "$databasefile"
		;;
	pkg_debian)
		docker run -i patton-debian --format=simple | awk '{ print $2 ": " $1 }' | tee /tmp/patton-debian
		;;

	pkg_ubuntu)
		pkgname=$(echo $pattern | awk '{ print $2 }')
		pkgversion=$(echo $pattern | awk '{ print $3 }')
		echo "searching ubuntu pkg ‘$pkgname’ version ‘$pkgversion’"
		zstdgrep -i -E "$pkgname" "$databasefile"
		;;
	pkg_ubuntu2)
		if [[ "$1" == - ]]; then
			echo 1>&2 Reading output of dpkg -l from stdin...

			awk -f <(awk -v s2rp="$DIR/soft2re-exe" 'BEGIN{print "BEGIN{IGNORECASE=1}"} /ii/ && length($2) > 3 {cmd=s2rp" \""$2"\" \""$3"\""; cmd | getline result; print "/"result"/ {print \""$2":\"$0}"; close(cmd) }') <(zstdcat "$databasefile") | tee /tmp/report
		fi
		;;
	*)
		zstdgrep -i -E "${pattern//\ /\.\*}" "$databasefile"
		;;
esac

exit 0
