from sqlalchemy import Column, String, Float, ForeignKey, DateTime
from sqlalchemy.orm import relationship

from patton.dal.database import Base
from . import fields


class Vuln(Base):
    __tablename__ = 'vuln'
    id = Column(String, primary_key=True)
    published = Column(DateTime)
    last_modified = Column(DateTime)
    cwe = Column(String)
    summary = Column(String)


    score = Column(Float)
    score_access_vector = Column(String)
    score_access_complexity = Column(String)
    score_authentication = Column(String)
    score_confidentiality_impact = Column(String)
    score_integrity_impact = Column(String)
    score_availability_impact = Column(String)
    score_source = Column(String)

    references = relationship('VulnReference', backref='vuln_reference')
    prods = relationship('VulnProduct', back_populates='vuln')

    def loader_map(root):
        def get_base_metrics(vuln, field):
            if vuln.find('{*}cvss') and vuln.find('{*}cvss').find('{*}base_metrics'):
                    return vuln.find('{*}cvss').find('{*}base_metrics').find(field).text
            return None

        return [
            {
                'id': vuln.attrib['id'],
                'published': fields.datetimep(vuln.find('{*}published-datetime').text),
                'last_modified': fields.datetimep(vuln.find('{*}last-modified-datetime').text),
                'cwe': fields.cwe(vuln),
                'summary': vuln.find('{*}summary').text,

                'score_access_vector': get_base_metrics(vuln, '{*}access-vector'),
                'score_access_complexity': get_base_metrics(vuln, '{*}access-complexity'),
                'score_authentication': get_base_metrics(vuln, '{*}authentication'),
                'score_confidentiality_impact': get_base_metrics(vuln, '{*}confidentiality-impact'),
                'score_integrity_impact': get_base_metrics(vuln, '{*}integrity-impact'),
                'score_availability_impact': get_base_metrics(vuln, '{*}availability-impact'),
                'score_source': get_base_metrics(vuln, '{*}source'),
            }

            for vuln in root.iter('{*}entry')
        ]


class VulnReference(Base):
    __tablename__ = 'vuln_reference'
    id = Column(String, primary_key=True, default=fields.uuid)
    vuln_id = Column(String, ForeignKey('vuln.id'))
    lang = Column(String)
    reference_type = Column(String)
    score = Column(String)
    href = Column(String)
    href_description = Column(String)

    def loader_map(root):
        return [
            {
                'id': fields.uuid(),
                'vuln_id': ref.getparent().getparent().attrib['id'],
                'lang': ref.attrib['{http://www.w3.org/XML/1998/namespace}lang'],
                'reference_type': ref.getparent().attrib['reference_type'],
                'source': ref.getparent().find('{*}source').text,
                'href': ref.attrib['href'],
                'href_description': ref.text,
            }
            for ref in root.iter('{*}reference')
        ]

    def to_dict(self) -> dict:
        return {
            'id': self.id,
            'vuln_id': self.vuln_id,
            'lang': self.lang,
            'reference_type': self.reference_type,
            'source': self.source,
            'href': self.href,
            'href_description': self.description,
        }


class VulnScore(Base):
    __tablename__ = 'vuln_score'
    id = Column(String, primary_key=True, default=fields.uuid)
    vuln_id = Column(String, ForeignKey('vuln.id'))


    def loader_map(root):
        return [
            {
                'id': fields.uuid(),
                'vuln_id': metric.getparent().getparent().attrib['id'],
                'score': float(metric.find('{*}score').text),

            }
            for metric in root.iter('{*}base_metrics')
        ]
